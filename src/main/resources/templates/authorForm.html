<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEditMode} ? 'Modifica Autore' : 'Aggiungi Autore'">Aggiungi Autore</title>
    <link rel="stylesheet" th:href="@{/css/autoreForm.css}">
    <link rel="stylesheet" th:href="@{/css/errors.css}">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Lista passata dal back-end
        var books = /*[[${booksList}]]*/ [];
        /*]]>*/
    </script>
</head>
<body>
<div th:insert="~{fragments/topBar :: site-header}"></div>

<div class="warped_box_for_card">
    <div class="author-form-card">
        <div class="icon-container">
            <div class="author-icon"><i class="fas fa-user-pen"></i></div>
        </div>
        <div class="title-section">
            <h1 th:text="${isEditMode} ? 'Modifica Autore' : 'Aggiungi Nuovo Autore'"></h1>
            <p class="subtitle"
               th:text="${isEditMode} ? 'Aggiorna l\'autore esistente' : 'Compila i campi per un nuovo autore'"></p>
        </div>

        <form id="authorForm"
              th:action="@{${formAction}}"
              th:object="${autore}"
              method="post"
              enctype="multipart/form-data">

            <!-- Nome / Cognome / Nazionalità / Date -->
            <div class="flex-row">
                <div class="form-group flex-col"><label for="nome">Nome *</label>
                    <input id="nome" th:field="*{nome}" class="input" required>
                    <div class="error-message" th:errors="*{nome}"></div>
                </div>
                <div class="form-group flex-col"><label for="cognome">Cognome *</label>
                    <input id="cognome" th:field="*{cognome}" class="input" required>
                    <div class="error-message" th:errors="*{cognome}"></div>
                </div>
            </div>
            <div class="form-group"><label for="nationality">Nazionalità *</label>
                <input id="nationality" th:field="*{nationality}" class="input" required>
                <div class="error-message" th:errors="*{nationality}"></div>
            </div>
            <div class="flex-row">
                <div class="form-group flex-col"><label for="dateOfBirth">Nascita *</label>
                    <input type="datetime-local" id="dateOfBirth" th:field="*{dateOfBirth}" class="input" required>
                    <div class="error-message" th:errors="*{dateOfBirth}"></div>
                </div>
                <div class="form-group flex-col"><label for="dateOfDeath">Morte</label>
                    <input type="datetime-local" id="dateOfDeath" th:field="*{dateOfDeath}" class="input">
                    <div class="error-message" th:errors="*{dateOfDeath}"></div>
                </div>
            </div>

            <!-- Libri associati -->
            <div class="form-group multi-select-container">
                <label for="bookInput">Libri Associati</label>
                <div class="selected-items" id="selectedBooks"></div>
                <input type="hidden" id="libriField" th:field="*{libri}">
                <input type="text" id="bookInput" class="input" placeholder="Cerca o aggiungi..."
                       autocomplete="off">
                <div class="dropdown" id="bookDropdown"></div>
                <div class="error-message" th:errors="*{libri}"></div>
            </div>

            <!-- Immagine -->
            <div class="form-group image-upload-container" id="imageUploadContainer">
                <label>Immagine Autore</label>
                <input type="file" id="imageUpload" name="images" accept="image/*" style="display:none;">
                <button type="button" id="uploadTrigger" class="btn submit-btn">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span th:text="${isEditMode} ? 'Cambia Immagine' : 'Carica Immagine'"></span>
                </button>
                <p class="subtitle">Trascina o clicca per selezionare</p>
                <div class="image-preview-container" id="imagePreview"></div>
                <div class="error-message" id="image-error"></div>
            </div>

            <!-- Bottoni -->
            <div class="btn-container">
                <button type="submit" class="btn submit-btn">
                    <i class="fas fa-paper-plane"></i>
                    <span th:text="${isEditMode} ? 'Aggiorna' : 'Salva'"></span>
                </button>
                <button type="reset" class="btn reset-btn"><i class="fas fa-undo"></i> Azzera</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
    // JS identico a prima, ripristinato per libri+immagini
    let selectedBooks = [], selectedImage = null;
    document.addEventListener('DOMContentLoaded', () => {
        // libro dropdown
        const dd = document.getElementById('bookDropdown');
        function renderDropdown() {
            dd.innerHTML = '';
            books.forEach(b => {
                const d = document.createElement('div');
                d.className = 'dropdown-item';
                d.textContent = b.title || b;  // se b è string o obj
                d.dataset.id = b.id||b;
                d.addEventListener('mousedown', () => selectBook(d.dataset.id, d.textContent));
                dd.appendChild(d);
            });
        }
        renderDropdown();
        document.getElementById('bookInput').addEventListener('input', () => {
            const v = bookInput.value.toLowerCase();
            dd.querySelectorAll('.dropdown-item').forEach(it => {
                it.style.display = it.textContent.toLowerCase().includes(v) ? 'block' : 'none';
            });
            dd.style.display = v? 'block':'none';
        });
        function selectBook(id, title) {
            if (!selectedBooks.find(x=>x.id==id)) {
                selectedBooks.push({id, title});
                updateSelected();
            }
            bookInput.value=''; dd.style.display='none';
        }
        function updateSelected() {
            const cont = document.getElementById('selectedBooks');
            cont.innerHTML = '';
            selectedBooks.forEach(x=>{
                const div = document.createElement('div');
                div.className='selected-item';
                div.innerHTML = `${x.title} <button class="remove-item">&times;</button>`;
                div.querySelector('button').onclick = () => {
                    selectedBooks = selectedBooks.filter(y=>y.id!=x.id);
                    updateSelected();
                };
                cont.appendChild(div);
            });
            // aggiorna hidden
            libriField.value = selectedBooks.map(x=>x.id).join(',');
        }

        // immagine upload + drag&drop
        const uploadBtn = document.getElementById('uploadTrigger'),
            fileIn = document.getElementById('imageUpload'),
            drop = document.getElementById('imageUploadContainer'),
            preview = document.getElementById('imagePreview'),
            err = document.getElementById('image-error');
        uploadBtn.onclick = () => fileIn.click();
        fileIn.onchange = e => handleFile(e.target.files[0]);
        ['dragover','drop','dragleave'].forEach(ev=>{
            drop.addEventListener(ev, e=>{
                e.preventDefault(); e.stopPropagation();
                if(ev=='drop') handleFile(e.dataTransfer.files[0]);
            });
        });
        function handleFile(f){
            if (!f || !f.type.startsWith('image/')) {
                err.textContent='File non valido'; return;
            }
            preview.innerHTML='';
            const r=new FileReader();
            r.onload=e=>{
                const img=document.createElement('img');
                img.className='image-preview'; img.src=e.target.result;
                const rem=document.createElement('div');
                rem.className='remove-image'; rem.innerHTML='&times;';
                rem.onclick=()=>{preview.innerHTML=''; fileIn.value='';};
                const c=document.createElement('div');
                c.className='image-actions'; c.append(img,rem);
                preview.appendChild(c);
            };
            r.readAsDataURL(f);
        }
    });
</script>
</body>
</html>
